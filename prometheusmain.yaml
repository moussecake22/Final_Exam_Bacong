---
- name: Install Docker dependencies
  package:
    name: "{{ item }}"
    state: present
  loop:
    - yum-utils
    - device-mapper-persistent-data
    - lvm2
  when: ansible_os_family == "RedHat"

- name: Add Docker repository (CentOS)
  yum_repository:
    name: docker-ce
    description: Docker CE Stable
    baseurl: https://download.docker.com/linux/centos/7/x86_64/stable
    gpgcheck: yes
    gpgkey: https://download.docker.com/linux/centos/gpg
    enabled: yes
  when: ansible_os_family == "RedHat"

- name: Install Docker
  package:
    name: docker-ce
    state: present
  when: ansible_os_family == "RedHat"

- name: Install Docker (Ubuntu)
  package:
    name: docker.io
    state: present
  when: ansible_os_family == "Debian"

- name: Start and enable Docker service
  systemd:
    name: docker
    state: started
    enabled: yes

- name: Install Docker Compose
  get_url:
    url: "https://github.com/docker/compose/releases/download/v2.20.0/docker-compose-linux-x86_64"
    dest: /usr/local/bin/docker-compose
    mode: "0755"

- name: Create monitoring directory structure
  file:
    path: "{{ item }}"
    state: directory
    mode: 0755
  loop:
    - /opt/monitoring
    - /opt/monitoring/config
    - /opt/monitoring/data

- name: Deploy Prometheus configuration
  template:
    src: prometheus.yml.j2
    dest: /opt/monitoring/config/prometheus.yml
    mode: 0644

- name: Deploy Docker Compose file
  copy:
    src: docker-compose.yaml
    dest: /opt/monitoring/docker-compose.yml
    mode: 0644

- name: Fix directory permissions
  file:
    path: /opt/monitoring/data
    owner: "1000"
    group: "1000"
    recurse: yes

- name: Start monitoring stack
  community.docker.docker_compose:
    project_src: /opt/monitoring
    state: present

- name: Wait for services to start
  wait_for:
    port: "{{ item }}"
    delay: 10
    state: started
    timeout: 60
  loop:
    - 9090
    - 9100
    - 3000

- name: Verify Prometheus is running
  uri:
    url: "http://localhost:9090/graph"
    method: GET
    status_code: 200
  register: prometheus_result
  until: prometheus_result.status == 200
  retries: 5
  delay: 10

- name: Verify Node Exporter is running
  uri:
    url: "http://localhost:9100/metrics"
    method: GET
    status_code: 200
  register: node_exporter_result
  until: node_exporter_result.status == 200
  retries: 5
  delay: 10
