---
- name: Install Nginx
  package:
    name: nginx
    state: present
  notify: restart nginx

- name: Create web root directory
  file:
    path: "{{ nginx.web_root }}"
    state: directory
    mode: 0755

- name: Deploy Nginx configuration
  template:
    src: nginx.conf.j2
    dest: /etc/nginx/nginx.conf
    backup: yes
  notify: restart nginx

- name: Create custom index page
  copy:
    content: |
      <!DOCTYPE html>
      <html>
      <head>
          <title>Welcome to Nginx - Final Exam</title>
          <style>
              body { font-family: Arial, sans-serif; margin: 40px; }
              .header { background: #f4f4f4; padding: 20px; border-radius: 5px; }
              .success { color: green; font-weight: bold; }
              .info { background: #e7f3ff; padding: 15px; border-radius: 5px; }
              .server-info { background: #f0f8ff; padding: 10px; margin: 10px 0; }
          </style>
      </head>
      <body>
          <div class="header">
              <h1>Success! Nginx is Running</h1>
              <p class="success">Final Exam - CPE212 Automating Server Management</p>
          </div>
          
          <div class="info">
              <h2>Server Information:</h2>
              <div class="server-info">
                  <p><strong>Hostname:</strong> {{ ansible_hostname }}</p>
                  <p><strong>IP Address:</strong> {{ ansible_default_ipv4.address }}</p>
                  <p><strong>OS:</strong> {{ ansible_distribution }} {{ ansible_distribution_version }}</p>
                  <p><strong>Managed by:</strong> {{ global.username }}</p>
              </div>
              <p><strong>Course:</strong> {{ global.course }}</p>
              <p><strong>Section:</strong> {{ global.section }}</p>
              <p><strong>Date:</strong> {{ ansible_date_time.iso8601 }}</p>
          </div>
          
          <h3>Services Installed:</h3>
          <ul>
              <li>✅ Nginx Web Server</li>
              <li>✅ Custom MOTD Configuration</li>
              <li>✅ Ansible Managed Infrastructure</li>
          </ul>
          
          <h3>Monitoring:</h3>
          <p>This server is being monitored by Prometheus on monitor01 (192.168.56.110)</p>
      </body>
      </html>
    dest: "{{ nginx.web_root }}/index.html"
    mode: 0644

- name: Ensure Nginx is running and enabled
  systemd:
    name: nginx
    state: started
    enabled: yes

- name: Verify Nginx installation
  uri:
    url: "http://localhost:80"
    method: GET
    status_code: 200
  register: nginx_result
  until: nginx_result.status == 200
  retries: 5
  delay: 2
